# 0.0.5

The prototype version 0.0.5 is modification of version 0.0.2 to get closer to
the Stacks 2.1 requirements. It is a minimal serial protocol that allows a
single application to communicate with the Ryder at a time. The client will
have to be aware of the progression of inputs depending on the initial command.
The Ryder responds with single-byte responses by default. Multi-byte responses
are indicated by a specific start byte. These types of responses contain
arbitrary data and are framed by a start and end byte, and may contain escape
sequences.

## Protocol flow

The Ryder starts in `LISTENING` mode, waiting for a single-byte command from the
list below. Once a command is received, the device will respond back with a
single-byte response (either a `SUCCESS` response or `ERROR` response).

Once the success or error response is received, the command is handled and the
device goes back to a `LISTENING` state. There are two exceptions:

1. The device responds with `RESPONSE_WAIT_USER_CONFIRM`. In that case, the
command prompted a user confirmation screen on the Ryder. The user has to
press Confirm or Cancel on the Ryder before it can continue processing the
command.
	1. If the user presses Cancel, the Ryder responds with an additional
	`RESPONSE_REJECTED`.
	2. If the user presses Confirm, the Ryder continues processing and may
	return any of the below responses.

2. The device responds with `RESPONSE_OUTPUT`. In that case, what will follow is
a data stream of arbitrary length. The end of the data stream is marked with
`RESPONSE_OUTPUT_END`. After that byte is received, the device will return back
to LISTENING state.
	1. If `RESPONSE_OUTPUT` is present in the data stream, then it is prefixed
	by `RESPONSE_ESC_SEQUENCE`.
	2. If `RESPONSE_ESC_SEQUENCE` is present in the data stream, then it is
	prefixed by `RESPONSE_ESC_SEQUENCE`.
	3. Data stream thus terminates on the first ``RESPONSE_OUTPUT_END`` that is
	not prefixed by `RESPONSE_ESC_SEQUENCE`.

## Commands

A list of all available commands. Note that some commands are unimplemented or
disabled in prototype firmware 0.0.5. Other commands exist as a convenience
function to ensure compatibility with the current authentication flow and will
be deprecated in a later version. The underlying byte values are an
implementation detail at this stage. Official libraries contain named constants
for each of the commands in the table.

The Ryder will only accept a command when it is in a `LISTENING` state. Once a
command is being processed (for example, an app sign in is requested), then the
flow has to be completed or cancelled before the next command can be sent.
Sending command sequences during this period my result in unexpected
behaviour.

### Available commands

| Name | Dec | Short description | UC | SI |
| ---- | ---- | ---- | ---- | ---- |
| `COMMAND_WAKE` | `1` | Wake the Ryder from (deep) sleep. | N | N |
| `COMMAND_INFO` | `2` | Retrieve basic information about the Ryder. | N | N |
| `COMMAND_SETUP` | `10` | Trigger wallet setup flow. | Y | N |
| `COMMAND_RESTORE_FROM_MNEMONIC` | `12` | Trigger restore mode via mnemonic phrase input. | Y | Y |
| `COMMAND_ERASE` | `13` | Trigger erase mode. | Y | N |
| `COMMAND_STACKS_APP_SIGN_IN_REQUEST_LEGACY` | `20` | Request app public key export. (Renamed from `COMMAND_EXPORT_APP_KEY`.) | Y | Y |
| `COMMAND_EXPORT_DERIVED_PUBLIC_KEY` | `40` | Export public key derived from master key chain | Y | Y |
| `COMMAND_REQUEST_TRANSACTION_SIGN` | `50` | Sign a transaction | Y | Y |
| `COMMAND_REQUEST_STRUCTURED_MESSAGE_SIGN` | `51` | Sign a structured data message (SIP018) | Y | Y |
| `COMMAND_REQUEST_IDENTITY_MESSAGE_SIGN` | `60` | Sign an identity message (JWT for Stacks authentication) | Y | Y |

**UC**: *User Confirmation*, the command requires user confirmation. If the user
rejects `RESPONSE_REJECTED` is sent.  
**SI**: *Send Input*, the Ryder can request additional input follow the command.  
__*__: Will require user confirmation in the future.

### Unimplemented commands

| Name | Dec | Short description | UC | SI |
| ---- | ---- | ---- | ---- | ---- |
| `COMMAND_UNLOCK` | `3` | Request unlock. (Unimplemented.) | / | / |
| `COMMAND_RESTORE_FROM_SEED` | `11` | Trigger restore mode via seed input. (Unimplemented.) | / | / |
| `COMMAND_CANCEL` | `100` | Cancel a user prompt. (Unimplemented.) | N | N |

**UC**: *User Confirmation*, the command requires user confirmation. If the user
rejects `RESPONSE_REJECTED` is sent.  
**SI**: *Send Input*, the Ryder can request additional input follow the command.  
__*__: Will require user confirmation in the future.

### Deprecated commands

The following commands are deprecated as of version 0.0.5 and will always
respond with `RESPONSE_ERROR_DEPRECATED` (`243`).

| Name | Dec | Short description | UC | SI |
| ---- | ---- | ---- | ---- | ---- |
| `COMMAND_EXPORT_APP_KEY_PRIVATE_KEY` | `21` | Request app private key export. | Y | Y |
| `COMMAND_EXPORT_OWNER_APP_KEY_PRIVATE_KEY` | `23` | Request owner private key and app private key. (Temporary prototype command for Stacks auth flow compatibility.) | Y | Y |
| `COMMAND_EXPORT_PUBLIC_IDENTITIES` | `30` | Request multiple public identities at once. | Y | Y |
| `COMMAND_EXPORT_PUBLIC_IDENTITY` | `31` | Export a specific public identity. | N* | Y |

**UC**: *User Confirmation*, the command requires user confirmation. If the user
rejects `RESPONSE_REJECTED` is sent.  
**SI**: *Send Input*, the Ryder can request additional input follow the command.  
__*__: Will require user confirmation in the future.

### Long description of available commands

#### `COMMAND_WAKE`

Wakes up the device.

Ryder always responds with `RESPONSE_OK`.

#### `COMMAND_INFO`

Returns basic information about the device as a byte sequence in the following
format: `ryder[version major][version minor][version patch]0[initialised status]`.
The `ryder` string at the start is static.

Since this is a multi-byte response, it is wrapped in a START/END output
sequence.

#### `COMMAND_SETUP`

Initiates the setup of the device with a newly generated seed phrase.

Returns `RESPONSE_OK` or `RESPONSE_WAIT_USER_CONFIRM` if the Ryder is already
set up.

#### `COMMAND_RESTORE_FROM_SEED`

Not implemented.

Returns `RESPONSE_ERROR_NOT_IMPLEMENTED`.

#### `COMMAND_RESTORE_FROM_MNEMONIC`

Returns `RESPONSE_SEND_INPUT` or `RESPONSE_WAIT_USER_CONFIRM` if the Ryder is
already set up. If the user confirms, will respond with `RESPONSE_SEND_INPUT`.

The first input should be a single byte that specifies the number of words in
the mnemonic. The number should be `12`, `18`, or `24`. Any other value results
in a `RESPONSE_ERROR_MNEMONIC_INVALID` response.

After the Ryder responds with the second `RESPONSE_SEND_INPUT`, a phrase of 12,
18, or 24 words in the order specified on the device should be sent as ASCII.
The words may be separated by a space (dec `32`) or a null byte (dec `0`). The
final word should also be terminated by a space or null byte. To abort the
restore, pass an "empty" word by sending a double null byte. After each word a
`RESPONSE_SEND_INPUT` is sent.

Ryder responds with `RESPONSE_OK` on success

Error codes:

- `RESPONSE_ERROR_MNEMONIC_INVALID` if the word count is not `12`, `18`, or
  `24`, or if the phrase contains words that are invalid.
- `RESPONSE_ERROR_MNEMONIC_TOO_LONG` if the number of words was longer than
  what was expected.


#### `COMMAND_ERASE`

Deletes all secrets from the device if the user confirms.

Ryder responds with `RESPONSE_OK` if the user confirms.

#### `COMMAND_STACKS_APP_SIGN_IN_REQUEST_LEGACY`

**Parameter** Two bytes to indicate the identity number (big endian short), and
  one byte to indicate the app domain length. The maximum app domain length is
  `100`.

Request a Stacks legacy app sign in using app domain input.

Ryder always responds with `RESPONSE_SEND_INPUT` and waits for the three byte
parameter. Once received, responds with another `RESPONSE_SEND_INPUT` and waits
for the app domain in ASCII format. If no error is encountered, the Ryder will
respond with `RESPONSE_WAIT_USER_CONFIRM`.

After confirmation, a START/END output sequence containing the wallet public
key (33 bytes), identity public key (33 bytes), and app private key (32 bytes)
in that order is returned by the Ryder.

The derivation paths for the wallet and identity public keys are
`m/44'/5757'/0'/0/{account}'` and `m/888'/0'/{account}`, respectively.

Error codes:

- `RESPONSE_ERROR_INPUT_TOO_LONG` if the app domain length byte was larger than
  `100`.
- `RESPONSE_ERROR_APP_DOMAIN_INVALID`  if the domain does not start with
  `http://` or `https://`.

#### `COMMAND_EXPORT_DERIVED_PUBLIC_KEY`

**Parameter** Dynamic length byte input representing the derivation path. The
  first byte defines the number of path segments. Each path segment is defined
  by two bytes. If first bit of the first byte of a segment is set, the child
  is hardened. Example: `m/44'/5757'/0'/0/0` translates to `[5, 128, 44, 150,
  125, 128, 0, 0, 0, 0, 0]`.

The Ryder always responds with `RESPONSE_SEND_INPUT` when the command is
received and waits for the above parameter. It will then respond with
`RESPONSE_WAIT_USER_CONFIRM`. If the user confirms the export request, Ryder
responds with a START/END output containing the derived 33 byte compressed
public key.

#### `COMMAND_REQUEST_TRANSACTION_SIGN`

**Parameter** Two bytes to indicate the identity index and 4 bytes that
  represents the transaction length in big endian. The maximum transaction
  length is `4096`.

The Ryder always responds with `RESPONSE_SEND_INPUT` and waits for the
parameter. It is followed by another `RESPONSE_SEND_INPUT` if there is no
error, upon which the raw transaction bytes should be sent.

The Ryder will then respond with `RESPONSE_WAIT_USER_CONFIRM`. If the user
confirms the sign request, the Ryder responds with a START/END output
containing the transaction signature.

Error codes:

- `RESPONSE_ERROR_INPUT_TOO_LONG` if the transaction length is more than
  `4096`.

*This command will return more granular errors for invalid transactions in the
future.*

#### `COMMAND_REQUEST_STRUCTURED_MESSAGE_SIGN`

**Parameter** Two bytes to indicate the identity index and 4 bytes that
  represents the structured message length in big endian. The maximum message
  length is `2048`.

The Ryder always responds with `RESPONSE_SEND_INPUT` and waits for the
parameter. It is followed by another `RESPONSE_SEND_INPUT` if there is no
error, upon which the raw message bytes should be sent.

Error codes:

- `RESPONSE_ERROR_INPUT_TOO_LONG` if the transaction length is more than
  `2048`, or if the payload exceeds the expected size.
- `RESPONSE_ERROR_INPUT_MALFORMED` if the structured message domain or
  payload is malformed (not a valid Clarity Value), or if the domain is
  not a valid SIP018 domain (missing required fields).

*This command will return more granular errors for invalid messages in the
future.*

## Responses

These are all the possible responses from Ryder prototype firmware version
0.0.5.

| Name | Dec | Short description | IR |
| ---- | ---- | ---- | ---- |
| `RESPONSE_OK` | `1` | Generic command OK/received. | Y |
| `RESPONSE_SEND_INPUT` | `2` | command received, send input. | Y |
| `RESPONSE_REJECTED` | `3` | The user rejected the request. | N |
| `RESPONSE_OUTPUT` | `4` | Start of output sequence. | Y |
| `RESPONSE_OUTPUT_END` | `5` | End of output. | N |
| `RESPONSE_ESC_SEQUENCE` | `6` | Output escape sequence. | N |
| `RESPONSE_WAIT_USER_CONFIRM` | `10` | The user is prompted for confirmation. | Y |
| `RESPONSE_LOCKED` | `11` | Device is locked, send PIN. (Unimplemented.) | / |

**IR**: *Initial Response*, the Ryder can immediately respond with this sequence
  after receiving a command.

### START/END output

Once the `RESPONSE_OUTPUT` sequence is received, the client should expect the
Ryder to output data of arbitrary length that ends with `RESPONSE_OUTPUT_END`.
If the data contains a byte value equal to `RESPONSE_OUTPUT_END` or
`RESPONSE_ESC_SEQUENCE`, it will be preceded by `RESPONSE_ESC_SEQUENCE`. The
client should keep reading until it encounters a `RESPONSE_OUTPUT_END` that is
not preceded by `RESPONSE_ESC_SEQUENCE`.  It should then remove any escape
sequences before processing the data.

## Error responses

In addition to the responses above, the Ryder may respond with one of the
following error codes. Some error codes are specific to one or more commands.

| Name | Dec | Short description |
| ---- | ---- | ---- |
| `RESPONSE_ERROR_UNKNOWN_COMMAND` | `255` | The received command byte does not relate to any known command. |
| `RESPONSE_ERROR_NOT_INITIALISED` | `254` | The Ryder is not initialised with a wallet. |
| `RESPONSE_ERROR_MEMORY_ERROR` | `253` | The Ryder encountered a memory error while processing the command or input. |
| `RESPONSE_ERROR_APP_DOMAIN_TOO_LONG` | `252` | The provided app domain is too long to be processed. This error code precedes the memory error code. |
| `RESPONSE_ERROR_APP_DOMAIN_INVALID` | `251` | The app domain does not start with `http://` or `https://`. |
| `RESPONSE_ERROR_MNEMONIC_TOO_LONG` | `250` | The provided mnemonic phrase is too long to be processed. This error code precedes the memory error code. |
| `RESPONSE_ERROR_MNEMONIC_INVALID` | `249` | The mnemonic phrase has an invalid word count or the checksum failed. |
| `RESPONSE_ERROR_GENERATE_MNEMONIC` | `248` | The Ryder could not generate a mnemonic phrase of the desired strength. |
| `RESPONSE_ERROR_INPUT_TIMEOUT` | `247` | The client waited too long with sending input. (Unimplemented.) |
| `RESPONSE_ERROR_NOT_IMPLEMENTED` | `246` | Prototype response code to indicate that the current feature is still being worked on. |
| `RESPONSE_ERROR_INPUT_TOO_LONG`| `245` | The input cannot be handled because of its length. |
| `RESPONSE_ERROR_INPUT_MALFORMED` | `244` | The input cannot be handled because it is malformed or in an unexpected format. |
| `RESPONSE_ERROR_DEPRECATED` | `243` | The command is deprecated and should no longer be used. |
